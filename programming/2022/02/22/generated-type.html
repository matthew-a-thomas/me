<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="How to dynamically generate a type at runtime in C#">

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Raleway:wght@700&display=auto">
    
    <title>Dynamically Generated Type - Matthew A. Thomas</title>
  </head>
  <body class="text-justify">
    <div class="container">
      <div class="list-group list-group-flush">
        <div class="list-group-item sticky-top">
          <h3 class="text-center">
  <a class="text-body" href="/" id="title">
    Matthew A. Thomas
  </a>
</h3>
        </div>
        <div class="list-group-item">
          
          <h1>Dynamically Generated Type</h1>
          
          
          <p><i>February 22, 2022&mdash;How to dynamically generate a type at runtime in C#</i></p>
          
          


          <p>There are a variety of ways to interact with C#’s type system. You
can:</p>
<ul>
  <li>Reflect over existing types</li>
  <li>Generate types
    <ul>
      <li>Statically at compile time
        <ul>
          <li>The normal way</li>
          <li>With code generation</li>
        </ul>
      </li>
      <li><strong>Dynamically at runtime</strong></li>
    </ul>
  </li>
</ul>

<p>Here’s some code that does that last category:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Example</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection.Emit</span><span class="p">;</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IFace</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="nf">Go</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">IFace</span> <span class="nf">Create</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">assemblyBuilder</span> <span class="p">=</span> <span class="n">AssemblyBuilder</span><span class="p">.</span><span class="nf">DefineDynamicAssembly</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">AssemblyName</span><span class="p">(</span><span class="s">"Generated"</span><span class="p">),</span>
            <span class="n">AssemblyBuilderAccess</span><span class="p">.</span><span class="n">Run</span>
        <span class="p">);</span>
        <span class="kt">var</span> <span class="n">moduleBuilder</span> <span class="p">=</span> <span class="n">assemblyBuilder</span><span class="p">.</span><span class="nf">DefineDynamicModule</span><span class="p">(</span><span class="s">"Generated"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">typeBuilder</span> <span class="p">=</span> <span class="n">moduleBuilder</span><span class="p">.</span><span class="nf">DefineType</span><span class="p">(</span><span class="s">"GeneratedType"</span><span class="p">,</span> <span class="n">TypeAttributes</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">TypeAttributes</span><span class="p">.</span><span class="n">Class</span><span class="p">);</span>
        <span class="n">typeBuilder</span><span class="p">.</span><span class="nf">AddInterfaceImplementation</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFace</span><span class="p">));</span>
        <span class="kt">var</span> <span class="n">methodBuilder</span> <span class="p">=</span> <span class="n">typeBuilder</span><span class="p">.</span><span class="nf">DefineMethod</span><span class="p">(</span><span class="s">"Go"</span><span class="p">,</span> <span class="n">MethodAttributes</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">MethodAttributes</span><span class="p">.</span><span class="n">Virtual</span><span class="p">,</span> <span class="n">CallingConventions</span><span class="p">.</span><span class="n">HasThis</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">),</span> <span class="n">Type</span><span class="p">.</span><span class="n">EmptyTypes</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">methodBuilder</span><span class="p">.</span><span class="nf">GetILGenerator</span><span class="p">();</span>
        <span class="n">generator</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldstr</span><span class="p">,</span> <span class="s">"Hello, world!"</span><span class="p">);</span>
        <span class="n">generator</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ret</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">type</span> <span class="p">=</span> <span class="n">typeBuilder</span><span class="p">.</span><span class="nf">CreateType</span><span class="p">()!;</span>
        <span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">Activator</span><span class="p">.</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">IFace</span><span class="p">)</span><span class="n">instance</span><span class="p">!;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="nf">Create</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="nf">Go</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!
</code></pre></div></div>

        </div>
        <div class="list-group-item">
          <footer class="font-italic" style="font-size: 0.8em;">
  <p>
    &copy; Matthew A. Thomas 2023&mdash;<a href="/about">About</a>&mdash;<a href="/privacy">Privacy Policy</a>
  </p>
</footer>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" crossorigin="anonymous"></script>
  </body>
</html>
<!-- View the source code here: https://github.com/matthew-a-thomas/me -->