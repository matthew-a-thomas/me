<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Making the work queue look more like an async lock">

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Raleway:wght@700&display=auto">
    
    <title>A More Ergonomic Async Lock (obsolete) - Matthew A. Thomas</title>
  </head>
  <body class="text-justify">
    <div class="container">
      <div class="list-group list-group-flush">
        <div class="list-group-item sticky-top">
          <h3 class="text-center">
  <a class="text-body" href="/" id="title">
    Matthew A. Thomas
  </a>
</h3>
        </div>
        <div class="list-group-item">
          
          <h1>A More Ergonomic Async Lock (obsolete)</h1>
          
          
          <p><i>June 15, 2022&mdash;Making the work queue look more like an async lock</i></p>
          
          




<p>
  This is the
  second
    
  post in a series about
  async locks:
</p>
<ol>
  
  <li>
    
    
    <a href="/programming/2022/06/14/reentrant-async-lock.html"><b>Reentrant Async Lock</b></a>&mdash;A correct implementation
    
  </li>
  
  <li>
    
    
    <b>A More Ergonomic Async Lock (obsolete)</b> (<i>this post</i>)&mdash;Making the work queue look more like an async lock
    
  </li>
  
  <li>
    
    
    <a href="/programming/2022/06/20/introducing-reentrantasynclock.html"><b>ReentrantAsyncLock NuGet Package</b></a>&mdash;Introducing the ReentrantAsyncLock package
    
  </li>
  
  <li>
    
    
    <a href="/programming/2022/06/20/questions-answered.html"><b>Questions Answered</b></a>&mdash;Answering some questions about ReentrantAsyncLock
    
  </li>
  
</ol>

<hr/>


          <div class="alert alert-warning">

<h2 id="warning">Warning</h2>

<p>The code described in this post has some issues. For example, the
code below doesn’t correctly handle cancellation. See
<a href="/programming/2022/06/20/introducing-reentrantasynclock.html">the next post</a> for a
better implementation that is more thoroughly tested.</p>

</div>

<p>I previously <a href="/programming/2022/06/14/reentrant-async-lock.html">described</a> how to
make an async lock that supports all three of these at once:</p>

<ul>
  <li>Reentrance</li>
  <li>Asynchronicity</li>
  <li>Mutual exclusion</li>
</ul>

<p>Now I’m going to show how to make it more ergonomic. With
<a href="/programming/2022/06/14/reentrant-async-lock.html">the <code class="language-plaintext highlighter-rouge">WorkQueue</code> class from that post</a>
and with the <code class="language-plaintext highlighter-rouge">EnterAsync</code> extension method shown below you’ll be able to write
code like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">readonly</span> <span class="n">WorkQueue</span> <span class="n">_asyncLock</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
<span class="k">readonly</span> <span class="kt">object</span> <span class="n">_resource</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

<span class="k">async</span> <span class="n">Task</span> <span class="nf">DoItAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="k">using</span> <span class="p">(</span><span class="k">await</span> <span class="n">_asyncLock</span><span class="p">.</span><span class="nf">EnterAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nf">ExclusivelyUse</span><span class="p">(</span><span class="n">_resource</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="the-enterasync-extension-method">The <code class="language-plaintext highlighter-rouge">EnterAsync</code> extension method</h2>

<p>This extension method sets <code class="language-plaintext highlighter-rouge">SynchronizationContext.Current</code> to the given
<code class="language-plaintext highlighter-rouge">SynchronizationContext</code>, then asynchronously enters it. When the returned
<code class="language-plaintext highlighter-rouge">IAsyncDisposable</code> is disposed of then <code class="language-plaintext highlighter-rouge">SynchronizationContext.Current</code> will be
reset to whatever it was before.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.CompilerServices</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SynchronizationContextExtensions</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">?,</span> <span class="n">IAsyncDisposable</span><span class="p">&gt;</span> <span class="n">CastToAsyncDisposable</span> <span class="p">=</span> <span class="n">state</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">IAsyncDisposable</span><span class="p">)</span><span class="n">state</span><span class="p">!;</span>
    <span class="k">static</span> <span class="k">readonly</span> <span class="n">Action</span> <span class="n">DoNothing</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{};</span>

    <span class="k">static</span> <span class="k">readonly</span> <span class="n">ConditionalWeakTable</span><span class="p">&lt;</span><span class="n">SynchronizationContext</span><span class="p">,</span> <span class="n">TaskFactory</span><span class="p">&gt;</span> <span class="n">SynchronizationContextToTaskFactoryMap</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IAsyncDisposable</span><span class="p">&gt;</span> <span class="nf">EnterAsync</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">SynchronizationContext</span> <span class="n">context</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cancellationToken</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromCanceled</span><span class="p">&lt;</span><span class="n">IAsyncDisposable</span><span class="p">&gt;(</span><span class="n">cancellationToken</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">previousContext</span> <span class="p">=</span> <span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
        <span class="n">SynchronizationContext</span><span class="p">.</span><span class="nf">SetSynchronizationContext</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">contextFactory</span> <span class="p">=</span> <span class="nf">GetOrCreateTaskFactory</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">disposable</span> <span class="p">=</span> <span class="n">AsyncDisposable</span><span class="p">.</span><span class="nf">Create</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span> <span class="p">==</span> <span class="n">context</span><span class="p">)</span>
                <span class="n">SynchronizationContext</span><span class="p">.</span><span class="nf">SetSynchronizationContext</span><span class="p">(</span><span class="n">previousContext</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">DoNothing</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ValueTask</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nf">EnterAsyncCore</span><span class="p">(</span><span class="n">contextFactory</span><span class="p">,</span> <span class="n">disposable</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">TaskFactory</span> <span class="nf">GetOrCreateTaskFactory</span><span class="p">(</span><span class="n">SynchronizationContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span> <span class="p">==</span> <span class="n">context</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">SynchronizationContextToTaskFactoryMap</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">factory</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">factory</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">scheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="nf">FromCurrentSynchronizationContext</span><span class="p">();</span>
        <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TaskFactory</span><span class="p">(</span><span class="n">scheduler</span><span class="p">);</span>
        <span class="n">SynchronizationContextToTaskFactoryMap</span><span class="p">.</span><span class="nf">AddOrUpdate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">factory</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">factory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IAsyncDisposable</span><span class="p">&gt;</span> <span class="nf">EnterAsyncCore</span><span class="p">(</span>
        <span class="n">TaskFactory</span> <span class="n">taskFactory</span><span class="p">,</span>
        <span class="n">IAsyncDisposable</span> <span class="n">disposable</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">taskFactory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="n">CastToAsyncDisposable</span><span class="p">,</span> <span class="n">disposable</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">_</span> <span class="p">=</span> <span class="n">disposable</span><span class="p">.</span><span class="nf">DisposeAsync</span><span class="p">();</span>
            <span class="k">throw</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">AsyncDisposable</span> <span class="p">:</span> <span class="n">IAsyncDisposable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">AsyncDisposable</span> <span class="n">Empty</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>

    <span class="n">Func</span><span class="p">&lt;</span><span class="n">ValueTask</span><span class="p">&gt;?</span> <span class="n">_disposeAsync</span><span class="p">;</span>

    <span class="nf">AsyncDisposable</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">ValueTask</span><span class="p">&gt;?</span> <span class="n">disposeAsync</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_disposeAsync</span> <span class="p">=</span> <span class="n">disposeAsync</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">AsyncDisposable</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">ValueTask</span><span class="p">&gt;</span> <span class="n">disposeAsync</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span><span class="p">(</span><span class="n">disposeAsync</span><span class="p">);</span>

    <span class="k">public</span> <span class="n">ValueTask</span> <span class="nf">DisposeAsync</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Exchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">_disposeAsync</span><span class="p">,</span> <span class="k">null</span><span class="p">)?.</span><span class="nf">Invoke</span><span class="p">()</span> <span class="p">??</span> <span class="k">default</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="a-passing-test-case">A passing test case</h2>

<p>The following test passes:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">EnterAsyncMethodShouldSwitchIntoAndOutOfGivenContext</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SynchronizationContext</span><span class="p">.</span><span class="nf">SetSynchronizationContext</span><span class="p">(</span><span class="k">null</span><span class="p">);</span> <span class="c1">// Necessary because xUnit's SynchronizationContexts like to waffle back and forth</span>
    <span class="kt">var</span> <span class="n">newContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SimpleWorkQueue</span><span class="p">();</span>
    <span class="k">await</span> <span class="k">using</span> <span class="p">(</span><span class="k">await</span> <span class="n">newContext</span><span class="p">.</span><span class="nf">EnterAsync</span><span class="p">(</span><span class="k">default</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">Same</span><span class="p">(</span><span class="n">newContext</span><span class="p">,</span> <span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">Null</span><span class="p">(</span><span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">isActuallyOutOfTheContext</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="n">newContext</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">isActuallyOutOfTheContext</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">spinWait</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SpinWait</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(!</span><span class="n">isActuallyOutOfTheContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">spinWait</span><span class="p">.</span><span class="nf">SpinOnce</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

        </div>
        <div class="list-group-item">
          <footer class="font-italic" style="font-size: 0.8em;">
  <p>
    &copy; Matthew A. Thomas 2023&mdash;<a href="/about">About</a>&mdash;<a href="/privacy">Privacy Policy</a>
  </p>
</footer>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" crossorigin="anonymous"></script>
  </body>
</html>
<!-- View the source code here: https://github.com/matthew-a-thomas/me -->